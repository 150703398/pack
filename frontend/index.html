<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>3D 装箱系统</title>
<link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
<div id="panel">
<h3>货柜尺寸 (cm)</h3>
长 <input id="cl" value="1200">
宽 <input id="cw" value="235">
高 <input id="ch" value="260">

<h3>货物清单</h3>
<table id="goodsTable">
<tr>
<th>#</th><th>L</th><th>W</th><th>H</th><th>kg</th><th>易碎</th><th>可堆</th><th>操作</th>
</tr>
</table>
<button onclick="addRow()">➕ 添加货物</button>
<button onclick="pack()">▶ 装箱</button>
</div>
<div id="view"></div>

<script>
const API = "https://packing-proxy.xxx.workers.dev"
const table = document.getElementById("goodsTable")

function addRow(l=100,w=80,h=60,weight=50,fragile=false,stackable=true){
  const row = document.createElement("tr")
  const idx = table.rows.length
  row.innerHTML = `
    <td>${idx}</td>
    <td contenteditable>${l}</td>
    <td contenteditable>${w}</td>
    <td contenteditable>${h}</td>
    <td contenteditable>${weight}</td>
    <td><input type="checkbox" ${fragile?"checked":""}></td>
    <td><input type="checkbox" ${stackable?"checked":""}></td>
    <td><button onclick="removeRow(this)">删除</button></td>
  `
  table.appendChild(row)
}

function removeRow(btn){
  btn.closest("tr").remove()
  for(let i=1;i<table.rows.length;i++){
    table.rows[i].cells[0].innerText=i
  }
}

// 初始化示例
addRow()
addRow(120,100,80,120,true,false)
Sortable.create(table, {animation:150, ghostClass:"sortable-ghost", handle:"td"})

let scene,camera,renderer,controls

function init3D(){
  scene = new THREE.Scene()
  scene.background = new THREE.Color(0xf0f0f0)
  camera = new THREE.PerspectiveCamera(60,(window.innerWidth-420)/window.innerHeight,1,5000)
  camera.position.set(800,500,800)
  renderer = new THREE.WebGLRenderer({antialias:true})
  renderer.setSize(window.innerWidth-420,window.innerHeight)
  const viewDiv=document.getElementById("view")
  viewDiv.innerHTML=""
  viewDiv.appendChild(renderer.domElement)
  controls = new THREE.OrbitControls(camera,renderer.domElement)
  scene.add(new THREE.AmbientLight(0xffffff,.8))
  const light = new THREE.DirectionalLight(0xffffff,.6)
  light.position.set(500,500,500)
  scene.add(light)
  animate()
}

function animate(){
  requestAnimationFrame(animate)
  controls.update()
  renderer.render(scene,camera)
}

// 装箱调用 Worker + FastAPI
function pack(){
  const CL=+document.getElementById("cl").value
  const CW=+document.getElementById("cw").value
  const CH=+document.getElementById("ch").value
  const cargos=[]
  for(let i=1;i<table.rows.length;i++){
    const cells=table.rows[i].querySelectorAll("td")
    cargos.push({
      id:"C"+i,
      length:+cells[1].innerText,
      width:+cells[2].innerText,
      height:+cells[3].innerText,
      weight:+cells[4].innerText,
      fragile:cells[5].querySelector("input").checked,
      stackable:cells[6].querySelector("input").checked
    })
  }
  fetch(API,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({container:{length:CL,width:CW,height:CH},cargos})
  }).then(r=>r.json()).then(draw)
}

function draw(data){
  init3D()
  const CL=data.container.length
  const CW=data.container.width
  const CH=data.container.height
  const containerGeo=new THREE.BoxGeometry(CL,CH,CW)
  const containerMat=new THREE.MeshBasicMaterial({color:0x333333,wireframe:true})
  const container=new THREE.Mesh(containerGeo,containerMat)
  container.position.set(CL/2,CH/2,CW/2)
  scene.add(container)
  data.placements.forEach(p=>{
    const geo=new THREE.BoxGeometry(p.length,p.height,p.width)
    const mat=new THREE.MeshLambertMaterial({color:p.fragile?0xff5555:0x55aaff})
    const mesh=new THREE.Mesh(geo,mat)
    mesh.position.set(p.x+p.length/2,p.y+p.height/2,p.z+p.width/2)
    scene.add(mesh)
  })
}
</script>
</body>
</html>
